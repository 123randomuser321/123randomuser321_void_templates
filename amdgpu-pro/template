# Template file for 'amdgpu-pro'
# References:
# Inspired by:
# https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=amdgpu-pro-installer
pkgname=amdgpu-pro
version=21.40.2
revision=1
archs="x86_64"
wrksrc=${pkgname}-${version}
create_wrksrc=yes
build_style=meta
hostmakedepends="tar xz"
_basedesc="Proprietary AMDGPU-Pro stack"
short_desc="${_basedesc} - meta package"
maintainer="Sembo Sadur <labmailssadur@gmail.com>"
license="Public Domain"
homepage="https://www.amd.com/en/support"
_magicnum=1350682 # Focal Fossa build
_x64=amd64.deb
_end64=${pkgname}_${version}-${_magicnum}_${_x64}
_basedist="https://repo.radeon.com/amdgpu/${version}/ubuntu/pool/proprietary"
distfiles="${_basedist}/v/vulkan-${pkgname}/vulkan-${_end64}"
checksum="a01d58a5efb60bf4d98c9a16814dcb7641567e5b2eca87fef0d528d2ee59d1ae"
restricted=yes


_lib64="opt/amdgpu-pro/lib/x86_64-linux-gnu"
_etc="opt/amdgpu-pro/etc"
_doc="usr/share/doc"


do_extract() {
	
	for f in ${XBPS_SRCDISTDIR}/${pkgname}-${version}/*.deb; do

		ar x --output ${wrksrc} ${f}

		tar xpf data.tar.xz

	done

}


vulkan-amdgpu-pro_package() {
	
	short_desc="${_basedesc} - Vulkan driver"
	conflicts="amdvlk"
	license="custom:AMDGPU-Pro"

	pkg_install() {

		vinstall ${_lib64}/amdvlk64.so.1.0 755 usr/lib
		ln -s amdvlk64.so.1.0 ${PKGDESTDIR}/usr/lib/amdvlk64.so

		sed -i "s#/opt/amdgpu-pro/lib/x86_64-linux-gnu/amdvlk64.so#/usr/lib/amdvlk64.so#" ${_etc}/vulkan/icd.d/amd_icd64.json

		vinstall ${_etc}/vulkan/icd.d/amd_icd64.json 644 usr/share/vulkan/icd.d

		vlicense ${_doc}/vulkan-${pkgname}/copyright

	}

}
