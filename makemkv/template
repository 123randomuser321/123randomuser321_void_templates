# Template file for 'makemkv'
# Generated by xnew
# Instructions adapted from official 'guide': https://www.makemkv.com/forum/viewtopic.php?f=3&t=224
# Partial adaption from Arch Linux's AUR: https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=makemkv
pkgname=makemkv
version=1.14.4beta
_dist_version=1.14.4
revision=2
create_wrksrc=yes
archs="i686 x86_64" # makemkvcon binary is provided for i386 and amd64 only
build_style=gnu-configure
hostmakedepends="pkg-config"
makedepends="glibc-devel libressl-devel zlib-devel expat-devel libavcodec ffmpeg-devel MesaLib-devel qt5-devel"
depends="glibc libressl zlib expat libavcodec ffmpeg qt5 libbluray"
short_desc="A program to convert or backup optical discs, including encrypted Blu-Rays"
maintainer="Sembo Sadur <labmailssadur@gmail.com>"
license="custom:MakeMKV,MPL,LGPL"
homepage="http://www.makemkv.com/"
distfiles="http://www.makemkv.com/download/makemkv-bin-${_dist_version}.tar.gz http://www.makemkv.com/download/makemkv-oss-${_dist_version}.tar.gz"
checksum="63c86822f34283e10660ac1a06d6f868cd12a891742d25807809575e1bddb56e 4061d95d088c1f924ac1b061a9a10f09eee9bfd9f638dcd37c8bf57602a63658" # for 1.14.4
nocross=yes
nopie_files="/usr/bin/makemkvcon"
shlib_provides="libmmbd.so.0 libdriveio.so.0 libmakemkv.so.1"


do_configure() {
	cd ${wrksrc}
	cd makemkv-oss-${_dist_version}
	./configure
}

do_build() {
	cd ${wrksrc}
	cd makemkv-bin-${_dist_version}
	install -d tmp
	echo accepted > tmp/eula_accepted # this prevents getting stuck in makemkv's eula prompt
	make ${makejobs}

	cd ${wrksrc}
	cd makemkv-oss-${_dist_version}
	make ${makejobs}
}

do_install() {
	cd ${wrksrc}
	cd makemkv-bin-${_dist_version}

	make install DESTDIR=${DESTDIR}


	cd ${wrksrc}
	cd makemkv-oss-${_dist_version}

	make install DESTDIR=${DESTDIR}

	vlicense License.txt # they don't do this themselves
}


makemkv-libaacs_package() {
	short_desc="Symlinks to expose MakeMKV's decryption to the system"
	version=1.14.4beta
	_dist_version=1.14.4
	revision=1
	depends="${sourcepkg}" # doesn't need a specific version
	conflicts="libaacs" # add libbdplus, should it become an official pkg
	shlib_requires="libmmbd.so.0"
	shlib_provides="libaacs.so.0 libbdplus.so.0"

	pkg_install() {
	mkdir -p ${PKGDESTDIR}/usr/lib
	cd makemkv-oss-${_dist_version}/out
	ln -sf libmmbd.so.0 ${PKGDESTDIR}/usr/lib/libaacs.so.0
	ln -sf libmmbd.so.0 ${PKGDESTDIR}/usr/lib/libbdplus.so.0
	}
}
