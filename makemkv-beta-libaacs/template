# Template file for 'makemkv-beta'
# Generated by xnew
# Instructions adapted from official 'guide': https://www.makemkv.com/forum/viewtopic.php?f=3&t=224
# Partial adaption from Arch Linux's AUR: https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=makemkv
pkgname=makemkv-beta # named like this, so that we can use 'version' later on
version=1.14.4
revision=1
#wrksrc=
create_wrksrc=yes # Multiple distfiles, hence necessary
archs="i686 x86_64"
build_style=gnu-configure
hostmakedepends="pkg-config"
makedepends="glibc-devel libressl-devel zlib-devel expat-devel libavcodec ffmpeg-devel MesaLib-devel qt5-devel"
depends="glibc libressl zlib expat libavcodec ffmpeg qt5 libbluray"
short_desc="A program to convert or backup optical discs, including encrypted Blu-Rays"
maintainer="Sembo Sadur <labmailssadur@gmail.com>"
license="custom:MakeMKV,MPL,LGPL"
homepage="http://www.makemkv.com/"
distfiles="http://www.makemkv.com/download/makemkv-bin-${version}.tar.gz http://www.makemkv.com/download/makemkv-oss-${version}.tar.gz"
checksum="63c86822f34283e10660ac1a06d6f868cd12a891742d25807809575e1bddb56e 4061d95d088c1f924ac1b061a9a10f09eee9bfd9f638dcd37c8bf57602a63658" # for 1.14.4
nocross=yes # makemkvcon binary is provided for i386 and amd64 only, see do_install
nopie=yes # shipped makemkvcon is non-pie, causing xbps-src to exit during do_install()
shlib_provides="libmmbd.so.0 libdriveio.so.0 libmakemkv.so.1"


do_configure() {
	cd ${wrksrc}
	cd makemkv-oss-${version}
	./configure # only the oss files need to be configured
}

do_build() {
	cd ${wrksrc}
	cd makemkv-bin-${version}
	install -d tmp
	echo accepted > tmp/eula_accepted # this prevents getting stuck in makemkv's eula prompt
	make ${makejobs}

	cd ${wrksrc}
	cd makemkv-oss-${version}
	make ${makejobs}
}

do_install() {
	cd ${wrksrc}
	cd makemkv-bin-${version}

	make install DESTDIR=${DESTDIR}


	cd ${wrksrc}
	cd makemkv-oss-${version}

	make install DESTDIR=${DESTDIR}

	vlicense License.txt # they don't do this themselves
}


makemkv-beta-libaacs_package() {
	short_desc="Symlinks to expose MakeMKV's decryption to the system"
	version=1.14.4
	revision=1
	depends="${sourcepkg}>=${version}_${revision} coreutils"
	conflicts="libaacs"
	shlib_requires="libmmbd.so.0"
	shlib_provides="libaacs.so.0 libbdplus.so.0"

	pkg_install() {
	mkdir -p ${PKGDESTDIR}/usr/lib
	cd makemkv-oss-${version}/out
	ln -sf libmmbd.so.0 ${PKGDESTDIR}/usr/lib/libaacs.so.0
	ln -sf libmmbd.so.0 ${PKGDESTDIR}/usr/lib/libbdplus.so.0
	}
}